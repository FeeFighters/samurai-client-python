If you're just interested in using the API in a basic form, you should use `samurai_client_python.core`. It will allow you to create Payment Methods and Transactions.

# Transparent Redirect

First, you need to create a payment method, you first need to use something called a Transparent Redirect. This is a form you place on your website where your users enter all their credit card information. This form posts directly to FeeFighters, so, again, your server never sees the more sensitive parts. Feefighters will redirect your users to a url on your site (which you specify in a hidden field), with the payment_method_token of a newly created Payment Method in a GET variable. An example form, with all the necessary fields, can be found in the FeeFighters API documentation, or else you can look in [transparent_redirect.html.example](/FeeFighters/samurai-client-python/blob/master/transparent_redirect.html.example) in this repository.

# PaymentMethod

## Create/Fetch

Now, you can create a PaymentMethod to get the information:

    from samurai_client_python.core import PaymentMethod

    payment_method = PaymentMethod(merchant_key = merchant_key, merchant_password = merchant_password,
        processor_token = processor_token, payment_method_token = payment_method_token)

This will create a PaymentMethod object based on the `payment_method_token` you pass in. You also have to have credentials for your merchant and processor ready. (If you don't have these, you should check with Fee Fighters.) This will fetch the information information from Fee Fighters right away. If you prefer to delay the fetch (since it hits the network and takes a second), you can supply the argument `do_fetch=False`, and call `fetch()` later:

    from samurai_client_python.core import PaymentMethod


    payment_method = PaymentMethod(merchant_key = merchant_key, merchant_password = merchant_password,
        processor_token = processor_token, payment_method_token = payment_method_token, do_fetch = False)

...

    success = payment_method.fetch()

Finally, you will probably end up having to supply the credentials in several places in your code, so you can cut down on repetition by creating a `FeeFighters` object first:

    feefighters = FeeFighters(merchant_key = merchant_key, merchant_password = merchant_password, processor_token = processor_token)

    payment_method = PaymentMethod(feefighters = feefighters, payment_method_token = payment_method_token)

...

    payment_method_2 = PaymentMethod(feefighters = feefighters, payment_method_token = payment_method_token_2)

After a successful fetch, payment_method gets populated with the less sensitive information. You can access it directly, `payment_method.first_name` for instance. Integer fields will be converted to Python `int`s, and date fields will be converted to Python `datetime`s. Look at the Samurai documentation, and [core.py](/FeeFighters/samurai-client-python/blob/master/core.py) to see what fields get populated when you fetch. To test whether a fetch is successful, you can check if the `fetch()` function returns `True`, or if `payment_method_2.populated` is set to `True`.

If something went wrong, you should check `payment_method.errors`. For non-error info, check `payment_method.info`. It is a list of dictionaries, each being a message. The keys are `'context'`, `'key'` (which error/info message), and `'source'` (either 'samurai', 'gateway', or 'client' [generated by this client, not taken from over the network] )

    >>> print payment_method.errors
    [{'source': 'processor', 'key': 'country_not_supported', 'context': 'processor.avs'}, {'source': 'processor', 'key': 'too_short', 'context': 'input.cvv'}]

...

    >>> print payment_method.info
    [{'context':'processor.transaction', 'key':'success', 'source':'samurai'}]

You should also check `payment_method.is_sensitive_data_valid` (it may end up `False` without anything in the errors list). If it's false, it means something's wrong with either the credit card number or the cvv, in which case you should send the user back to the transparent redirect form. You should use the other fields in `payment_method` to pre-populate the form this time. It should also be noted that, unfortunately, the data, other than the credit card number and cvv being _malformed_, is not validated, until a transaction takes place. So be prepared to test for the first transaction returning False, and sending the user back to the transparent redirect form to try again.

## Update

If you want to change some of the less sensitive data (name, address, card expiration date, etc) you can do it directly. Just set the fields you want to change, and call `update()`. Also note that one of the fields is called "custom". This is for arbitrary data you would like FeeFighters to associate with the PaymentMethod. This client represents this field as a dictionary, and will convert it to JSON. Example:

    payment_method.expiry_year = 2020
    payment_method.last_name = "Johnson"
    payment_method.custom = {'a':'b'}

    payment_method.update()

...

Numerical data can be set as number, they will be converted into strings before saving. The DateTime fields (time updated, etc) cannot be updated. You should only put strings into the JSON field. (You can also put the custom information into a hidden field in the Transparent Redirect form if you json encode it first.)

## Retain

If you decide to that a PaymentMethod is good to continue using for the long run, you should retain it:

    payment_method.retain()

## Redact

If you have a PaymentMethod that you don't plan to use again, you should redact it:

    payment_method.redact()

# Transaction

## Create/Fetch

To start a series of transactions, first create a Transaction object. It requires a PaymentMethod object. Similarly to PaymentMethod, it also requires your credentials, which you can supply explicitly, or use an existing FeeFighters object for shorthand:

    from samurai_client_python.core import Transaction

    transaction = Transaction(merchant_key = test_credentials.merchant_key, merchant_password = test_credentials.merchant_password,
                processor_token = test_credentials.processor_token, payment_method = payment_method)

or

    transaction = Transaction(feefighters = feefighters, payment_method = payment_method, 
        processor_token = processor_token)

You can also create a Transaction object from an existing transaction on FeeFighters' system, by feeding in a Reference ID:

    transaction = Transaction(feefighters = feefighters, reference_id = reference_id)

As with PaymentMethod objects, it will fetch by default, but you can choose to split it up:

    transaction = Transaction(feefighters = feefighters, reference_id = reference_id, do_fetch = False)

...

    success = transaction.fetch()

## Purchase

To initiate a one-step payment, create a new Transaction with a PaymentMethod, and call `purchase()`:

    success = transaction.purchase(20, "USD", billing_reference, customer_reference)

`billing_reference` should be a number unique to this set of transactions. `customer_reference` should be unique to the user. After (Note that `transaction.amount` will be of type str.)

## Authorize/Capture

To initiate a two-step payment, create a new Transaction with a PaymentMethod, and call `authorize()`:

    success = transaction.authorize(20, "USD", billing_reference, customer_reference)
    # save transaction.reference_id somewhere

At a later time, you presumably will have the reference_id of the previous transaction saved. Use that to create a new transaction, and then call `capture()`

    authorize_transaction = Transaction(feefighters = feefighters, reference_id = reference_id)
    capture_transaction = authorize_transaction.capture(20) # you can generally capture up to as much money as you authorized for

The `capture_transaction` will have the same `transaction_token` as the `authorize_transaction`, but a different `reference_id`.

## Void

For any existing transaction, you can simply call void() to cancel it (if done soon enough, talk to Fee Fighters for detals):

    existing_transaction = Transaction(feefighters = feefighters, reference_id = reference_id)
    void_transaction = existing_transaction.void()

The `void_transaction` will have the same `transaction_token` as the `existing_transaction`, but a different `reference_id`.

## Credit 

For a transaction where a payment has been made, you can refund it partially or entirely by calling `credit()`:

    existing_transaction = Transaction(feefighters = feefighters, reference_id = reference_id)
    credit_transaction = existing_transaction.void()

The `credit_transaction` will have the same `transaction_token` as the `existing_transaction`, but a different `reference_id`.


